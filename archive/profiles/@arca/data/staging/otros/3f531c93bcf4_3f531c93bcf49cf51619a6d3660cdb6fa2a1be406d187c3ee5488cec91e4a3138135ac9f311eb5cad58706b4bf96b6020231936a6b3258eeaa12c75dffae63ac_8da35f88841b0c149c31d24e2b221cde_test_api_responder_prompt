---
module: prompts/test_api_responder_prompt
type: core
status: in_progress
created: '2025-05-26'
linked_to:
- metodologia_doc_ia_v2.md

---
# âœ… Solicitud de Test â€“ `test_api_responder.py` â€“ ALMA_RESIST Sprint 2.6

Este test debe validar completamente el endpoint `/responder` expuesto por `main.py` (FastAPI), el cual estÃ¡ integrado con los siguientes mÃ³dulos:

- `model_wrapper.py` â†’ GeneraciÃ³n con llama.cpp
- `transport_layer.py` â†’ ValidaciÃ³n contra `schema_prompt.json` y persistencia
- `context_tracker.py` â†’ Registro de interacciones
- `log_writer.py` (opcional) â†’ Logging estructurado

---

## ğŸ¯ Objetivo

Desarrollar el archivo `tests/test_api_responder.py` usando `pytest` y `TestClient` de FastAPI para verificar el correcto funcionamiento de la API LLM, su manejo de errores, estructura de respuesta y validaciÃ³n semÃ¡ntica.

---

## ğŸ“˜ Requisitos funcionales

### Endpoint: `POST /responder`

- âœ… Devuelve 200 OK con prompt vÃ¡lido
- âœ… Devuelve un `dict` con:
  - `"respuesta"`: `str`
  - `"metadata"`: `{ modelo: str, longitud_prompt: int, timestamp: float }`

### Validaciones esperadas:
- âŒ Prompt vacÃ­o â†’ `422 Unprocessable Entity` (por validaciÃ³n Pydantic)
- âŒ Modelo no cargado â†’ `503 Service Unavailable`
- âŒ Error interno (simulado) â†’ `500 Internal Server Error`

---

## ğŸ”§ Consideraciones tÃ©cnicas

- Usar `from fastapi.testclient import TestClient`
- Mockear `ModelWrapper.generate()` si fuera necesario para evitar carga real
- Usar fixtures de `pytest` si es posible para levantar la app (`client = TestClient(app)`)
- Verificar tipos, claves presentes y que no devuelva estructuras invÃ¡lidas
- Verificar integraciÃ³n con `TransportLayer` y `ContextTracker` si se desea ampliar la prueba

---

## ğŸ§ª Casos de prueba sugeridos

| Caso                                 | Esperado                        |
|--------------------------------------|----------------------------------|
| `POST /responder` con prompt vÃ¡lido  | 200 OK, estructura vÃ¡lida        |
| Prompt vacÃ­o                         | 422 (Pydantic)                   |
| Modelo no cargado                    | 503, mensaje: "modelo no cargado"|
| Respuesta sin metadata               | âŒ (debe incluirla siempre)      |
| Errores internos simulados           | 500 con mensaje de error         |

---

## ğŸ“‚ Archivos disponibles

- `main.py` (servidor FastAPI)
- `model_wrapper.py`
- `transport_layer.py`
- `context_tracker.py`
- `schema_prompt.json`
- `schema_respuesta.json`
- `test_model_wrapper.py` (ya implementado)

---

Â¿PodÃ©s generar el archivo `test_api_responder.py` siguiendo esta estructura y cubriendo todos los casos mencionados con `pytest` + `TestClient`?
