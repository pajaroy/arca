#!/bin/bash
# Instalador automatizado para Arch Linux en modo BIOS con LUKS y particiones múltiples

# Variables
DISK="/dev/sda"

# Confirmación
echo "Esto eliminará todo en $DISK. ¿Estás seguro? (sí/no)"
read CONFIRM
if [[ "$CONFIRM" != "sí" ]]; then
    echo "Cancelado."
    exit 1
fi

# Desmontar
umount -R /mnt 2>/dev/null
swapoff -a

# Borrar discos
wipefs -a "$DISK"
sgdisk --zap-all "$DISK"

# Crear tabla de particiones BIOS (msdos)
parted -s "$DISK" mklabel msdos

# Crear particiones
# sda1 -> SWAP 16G
# sda2 -> /boot 512M
# sda3 -> Parrot 30G
# sda4 -> Arch root con LUKS (el resto)
parted -s "$DISK" mkpart primary linux-swap 1MiB 16GiB
parted -s "$DISK" mkpart primary ext2 16GiB 16.5GiB
parted -s "$DISK" mkpart primary ext4 16.5GiB 46.5GiB
parted -s "$DISK" mkpart primary ext4 46.5GiB 100%

# Formatear
mkswap "${DISK}1"
mkfs.ext2 "${DISK}2" -L "BIOSBOOT"
mkfs.ext4 "${DISK}3" -L "PARROT"
cryptsetup luksFormat "${DISK}4"
cryptsetup open "${DISK}4" cryptroot
mkfs.btrfs /dev/mapper/cryptroot -L "ARCHROOT"

# Montar
mount /dev/mapper/cryptroot /mnt
mkdir -p /mnt/boot
mount "${DISK}2" /mnt/boot
swapon "${DISK}1"

echo "Particionado y formateo completado. Sistema listo para instalación de Arch."
