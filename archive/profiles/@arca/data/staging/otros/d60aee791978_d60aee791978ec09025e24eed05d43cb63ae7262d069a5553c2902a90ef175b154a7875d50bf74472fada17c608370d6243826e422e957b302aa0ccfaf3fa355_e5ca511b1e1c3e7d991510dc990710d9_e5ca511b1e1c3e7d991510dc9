---
module: control/sprints_activos/sprint_2_6_llm_server
type: core
status: in_progress
created: '2025-05-26'
linked_to:
- metodologia_doc_ia_v2.md

---
# âœ… Sprint 2.6 â€“ LLM Server + Roadmap 0.0.0.2 â€“ ALMA_RESIST

ğŸ“… VersiÃ³n objetivo: v0.0.0.2  
ğŸ§  Objetivo: Implementar el servidor MVP `idea_base_llm_server_0.0.0.4.1` y finalizar todas las tareas del roadmap tÃ©cnico v0.0.0.2

---

## ğŸ”§ Fase 1 â€“ Servidor LLM MVP

- [x] Crear API con FastAPI (`main.py`)
- [x] Implementar endpoint `/responder` (asincrÃ³nico)
- [x] Integrar `ModelWrapper` con llama.cpp (GGUF Q4)
- [x] Documentar contratos en `docs/contracts/`
  - [x] `schema_prompt.json`
  - [x] `schema_respuesta.json`
- [x] Implementar `TransportLayer` (JSON local)
- [ ] Probar respuesta funcional desde CLI

- [ ] AÃ±adir manejo de errores en `/responder`:
  - Validar si el modelo estÃ¡ cargado
  - Detectar prompts invÃ¡lidos


---

## ğŸ”’ Fase 2 â€“ Logging y Seguridad

- [x] Usar `log_crypto.py` para cifrado AES-GCM
- [ ] Registrar cada respuesta cifrada en SQLite
- [ ] Validar contra JSON Schema
- [x] Integrar con `context_tracker` para logs de actividad
- [x] Registrar resultados en `memory_graph`
- [x] Conectar `memory_graph` para indexar embeddings de respuestas
- [x] Integrar `context_tracker` al registrar actividad/logs


---

## ğŸ§ª Fase 3 â€“ Pruebas Automatizadas

- [x] Crear `test_cli.py` con flujo mÃ­nimo CLI â†’ server
- [x] Crear `test_llm.py` con mock del modelo
- [x] Crear `test_log_writer.py` y `test_log_crypto.py` con `pytest`
- [ ] Validar el flujo: CLI â†’ respuesta â†’ memoria â†’ logging seguro
- [ ] Reemplazar `test_llm.py` con prueba **end-to-end**:
  - Validar flujo `CLI â†’ servidor â†’ memoria` directamente
  - Evitar mocks innecesarios

## ğŸ“Œ ApÃ©ndice TÃ©cnico â€“ Plan de Tests Automatizados (Fase 3)

Este apÃ©ndice detalla la suite de tests necesaria para cubrir funcionalmente todos los mÃ³dulos desarrollados en el Sprint 2.6 bajo el nuevo modelo modular de ALMA_RESIST. Todos los tests deben migrarse o crearse bajo la nueva arquitectura.

---

### âœ… Tests existentes a refactorizar

| Archivo original     | Estado         | AcciÃ³n recomendada                           |
|----------------------|----------------|----------------------------------------------|
| `test_llm.py`        | Obsoleto       | Refactorizar como `test_model_wrapper.py`    |
| `test_cli.py`        | Parcial        | Migrar a `test_api_responder.py`             |
| `test_log_crypto.py` | Parcial        | Mantener y extender                          |

---

### ğŸ§ª Nuevos tests a implementar

| Archivo sugerido          | MÃ³dulo testeado      | Casos clave                                                                 |
| ------------------------- | -------------------- | --------------------------------------------------------------------------- |
| `test_model_wrapper.py`   | `model_wrapper.py`   | Carga del modelo, errores por ruta invÃ¡lida, generaciÃ³n con prompt vÃ¡lido   |
| `test_api_responder.py`   | `main.py` (FastAPI)  | Status 200, 422 input invÃ¡lido, 503 modelo no cargado, estructura de salida |
| `test_transport_layer.py` | `transport_layer.py` | EnvÃ­o y recuperaciÃ³n, validaciÃ³n con schema, escritura/lectura de archivos  |
| `test_context_tracker.py` | `context_tracker.py` | Registro de interacciÃ³n, validaciÃ³n JSON Schema, recuperaciÃ³n, limpieza     |
| `test_log_writer.py`      | `log_writer.py`      | Escritura atÃ³mica, validaciÃ³n bÃ¡sica, simulaciÃ³n de error de disco          |
| `test_log_crypto.py`      | `log_crypto.py`      | Cifrado, descifrado, detecciÃ³n de algoritmo, verificaciÃ³n de nonce          |
| `test_memory_graph.py`    | `memory_graph.py`    | (Pendiente) InserciÃ³n de nodos, relaciones, exportaciÃ³n, bÃºsqueda por peso  |

---

### ğŸ§± Requisitos tÃ©cnicos

- Usar `pytest` como motor principal
- Evitar dependencias externas (usar mocks para modelo si es necesario)
- Las rutas de escritura deben apuntar a carpetas temporales (`tmp/` o `tests/data`)
- Agregar al menos un test por caso de error (input invÃ¡lido, fallo en carga, etc.)
- Incluir fixtures o mocks si el modelo no puede ser cargado durante CI

---

### ğŸ“‚ UbicaciÃ³n sugerida

```plaintext
tests/
â”œâ”€â”€ test_model_wrapper.py
â”œâ”€â”€ test_api_responder.py
â”œâ”€â”€ test_transport_layer.py
â”œâ”€â”€ test_context_tracker.py
â”œâ”€â”€ test_log_writer.py
â”œâ”€â”€ test_log_crypto.py
â””â”€â”€ test_memory_graph.py
```

---

### ğŸ§  Notas finales

Una vez finalizada esta suite, se podrÃ¡:
- Validar automÃ¡ticamente los endpoints
- Simular interacciones completas
- Auditar integridad de archivos
- Iniciar testeo CI/CD desde CLI o pre-commit

Este plan cumple los requisitos de la Fase 3 del Sprint 2.6 y establece una base sÃ³lida para testear futuras versiones del servidor.


---

## ğŸ§¹ Fase 4 â€“ DocumentaciÃ³n y Limpieza

- [ ] Actualizar `README.md` con:
  - [ ] comandos CLI
  - [ ] requisitos mÃ­nimos de hardware
  - [ ] dependencias Python
- [ ] Completar `docs/decisiones_arquitectonicas.md` con diseÃ±o final del server
- [ ] Ejecutar `tree` actualizado del sistema
- [ ] Guardar en `docs/auditorias/estructura_v0.0.0.2.md`
- [ ] Incluir requisitos de hardware mÃ­nimo:
  - Mistral 7B Q4 (~6GB RAM)
  - Alternativa: TinyLlama 1.1B (~2GB RAM)
- [ ] Esquematizar `decisiones_arquitectonicas.md` sin detalle excesivo


---

## ğŸ—ƒï¸ Fase 5 â€“ Versionado y Cierre

- [ ] Congelar versiÃ³n `0.0.0.1` en `docs/versiones/`
- [ ] Registrar hito del Sprint en `docs/hitos/`
- [ ] Agregar lecciones aprendidas a `lecciones_aprendidas.md`
- [ ] Confirmar cumplimiento de:
  - [ ] `python core/cli.py` responde sin errores
  - [ ] Se levanta modelo `.gguf` desde CLI
  - [ ] Se guarda memoria como JSON cifrado
  - [ ] Todas las pruebas pasan

---

## ğŸ§­ RecomendaciÃ³n Operativa

> â€œUn MVP no se mide por lo que incluye, sino por lo que resuelve. Priorizar es el arte de construir lo esencial sin perder de vista el horizonte.â€


---

# ğŸ“ ApÃ©ndice Sprint 2.6 â€“ Feedback TÃ©cnico de DeepSeek

Este apÃ©ndice resume los ajustes recomendados por DeepSeek para mejorar el Sprint 2.6 de ALMA_RESIST, sin duplicar tareas ya definidas. Aplica como guÃ­a adicional para asegurar escalabilidad, foco y realismo.

---

## ğŸ›¡ï¸ Riesgos TÃ©cnicos Identificados

- Sobrecarga de RAM:
  - SoluciÃ³n: Usar TinyLlama si hay hardware limitado

- Falta de retrocompatibilidad:
  - SoluciÃ³n: Definir y documentar contratos JSON desde el inicio

- Testing insuficiente:
  - SoluciÃ³n: Incluir 2-3 pruebas crÃ­ticas en `test_basico.sh`

---

## ğŸ“† Plan Semanal Ajustado

### Semana 1-2:
- FastAPI + `/responder`
- `ModelWrapper`
- Manejo de errores

### Semana 2-3:
- Logging cifrado
- `memory_graph`
- `context_tracker`

### Semana 3:
- Test end-to-end
- ValidaciÃ³n de logs

### Semana 4:
- README.md + requisitos
- Congelar versiÃ³n + lecciones aprendidas

---

## ğŸ’¡ ConclusiÃ³n

El Sprint 2.6 es totalmente viable si se priorizan:
- Integraciones clave sobre documentaciÃ³n extensa
- Pruebas funcionales sobre cobertura exhaustiva
- TinyLlama como alternativa realista en hardware limitado

> â€œLa escalabilidad no es una meta, sino un hÃ¡bito. Cada lÃ­nea de cÃ³digo debe escribirse como si maÃ±ana tuviera que soportar diez veces su carga.â€


---

## ğŸ“Œ ApÃ©ndice: Resumen de Avance TÃ©cnico â€“ Sprint 2.6 (2025-05-26)

Este resumen agrupa todos los mÃ³dulos, archivos y tareas ya completadas hasta la fecha, correspondientes a la Fase 1 y parcialmente a la Fase 2 del sprint.

---

### âœ… MÃ³dulos implementados

- `core/llm_server/main.py`  
  Servidor FastAPI con endpoint `/responder` asincrÃ³nico

- `core/llm_server/model_wrapper.py`  
  IntegraciÃ³n con `llama.cpp`, carga de modelo GGUF, generaciÃ³n

- `core/llm_server/transport_layer.py`  
  Manejo de entrada/salida JSON validado contra contratos, persistencia local

- `core/llm_server/integration/context_tracker.py`  
  Registro contextual de interacciones, cachÃ© en memoria, formato JSONL validado

- `core/llm_server/utils/log_writer.py`  
  Logger estructurado con escritura atÃ³mica y rotaciÃ³n de logs

- `core/llm_server/utils/log_crypto.py`  
  Cifrado de logs con AES-256-GCM o ChaCha20 segÃºn hardware

---

### ğŸ“ DocumentaciÃ³n estructural

- `docs/contracts/schema_prompt.json`  
- `docs/contracts/schema_respuesta.json`  
- `docs/contracts/README.md`  

Todos alineados con los modelos de entrada/salida reales.

---

### âš™ï¸ IntegraciÃ³n funcional

- El endpoint `/responder` ya ejecuta el modelo, valida el prompt y genera respuesta
- `ModelWrapper` es invocado correctamente desde `main.py`
- Respuestas son validadas y pueden ser almacenadas por `TransportLayer`
- Interacciones ya se registran automÃ¡ticamente en `context_tracker`
- Sistema de logs y cifrado preparado para activarse con mÃ­nima configuraciÃ³n extra

---

### ğŸ§© Pendientes inmediatos

- Finalizar mÃ³dulo `memory_graph.py`
- Probar respuesta desde CLI
- Integrar logging en tiempo real (`log_writer`)
- Preparar test unitarios de entrada/salida (Fase 3)
- Iniciar documentaciÃ³n final y cierre del sprint

---
# ğŸ“ ApÃ©ndice TÃ©cnico â€“ Sprint 2.6

**Fecha:** 2025-05-28  
**UbicaciÃ³n del mÃ³dulo:** `core/llm_server/utils/log_crypto.py`  
**VersiÃ³n:** `v0.0.0.4`

---

## ğŸ”§ Refactor y ValidaciÃ³n CriptogrÃ¡fica

Durante el Sprint 2.6 se realizÃ³ una refactorizaciÃ³n completa del mÃ³dulo `log_crypto.py`, responsable del cifrado y descifrado de logs internos en ALMA_RESIST.

### âœ… Logros:

- âœ… **Todos los tests unitarios pasaron** (16/16 `pytest`)
- ğŸ” **CorrecciÃ³n de errores crÃ­ticos** en el paso de claves y derivaciÃ³n de salt
- ğŸ§ª **Cobertura completa** con `pytest` usando `parametrize` (AES-GCM y ChaCha20)
- ğŸ“„ Se redactÃ³ un **README tÃ©cnico** con descripciÃ³n de uso, funciones, algoritmos soportados y dependencias

### ğŸ› ï¸ Cambios tÃ©cnicos principales:

- `decrypt_log()` ahora recibe una `password` y se encarga internamente de derivar la clave + salt.
- Se eliminaron llamadas errÃ³neas a tuplas como claves directas.
- ModularizaciÃ³n de funciones internas: `_get_cipher`, `_read_salt`, `_derive_key`.

---

## ğŸ“ Documentos Relacionados

- `log_crypto.py` â†’ [`core/llm_server/utils/log_crypto.py`](../core/llm_server/utils/log_crypto.py)
- `test_log_crypto.py` â†’ [`tests/test_log_crypto.py`](../tests/test_log_crypto.py)
- `README_log_crypto.md` â†’ DocumentaciÃ³n tÃ©cnica del mÃ³dulo

Este apÃ©ndice se considera **parte del cierre del Sprint 2.6** y no requiere entrada adicional en README global ni resumen MVP.  
SerÃ¡ referenciado en el changelog general de Sprint al cierre formal.

---
